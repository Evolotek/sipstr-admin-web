name: Deploy Terraform

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Select the branch to deploy"
        required: true
        default: "main"
        type: choice
        options:
          - main
          - release/integration
          - feature/dev
      rollback_enabled:
        description: "‚ö†Ô∏è Destroy infrastructure if deployment fails?"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
      - release/integration
      - "*"

permissions:
  id-token: write
  contents: read

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      subdomain: ${{ steps.set-env.outputs.subdomain }}

    steps:
      - name: Set environment and subdomain
        id: set-env
        run: |
          echo "üîç BRANCH: ${GITHUB_REF_NAME}"

          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "subdomain=admin" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF_NAME}" == "release/integration" ]]; then
            echo "environment=sandbox" >> $GITHUB_OUTPUT
            echo "subdomain=admin.sandbox" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "subdomain=admin.dev" >> $GITHUB_OUTPUT
          fi

          echo "Selected Environment: $(grep environment $GITHUB_OUTPUT | cut -d= -f2)"
          echo "Selected Subdomain: $(grep subdomain $GITHUB_OUTPUT | cut -d= -f2)"

  terraform:
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Terraform Init
        id: init
        run: |
          export TF_LOG=DEBUG
          export TF_LOG_PATH=terraform-debug.log
          terraform init \
            -backend-config="bucket=sipstr-admin-terraform-state" \
            -backend-config="key=${{ needs.determine-environment.outputs.environment }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="encrypt=true"
        working-directory: infra

      - name: Terraform Plan
        id: plan
        run: terraform plan -input=false -out=tfplan || true
        working-directory: infra
        env:
          TF_VAR_env: ${{ needs.determine-environment.outputs.environment }}
          TF_VAR_subdomain: ${{ needs.determine-environment.outputs.subdomain }}

      - name: Terraform Apply
        id: apply
        run: terraform apply -input=false -auto-approve tfplan || true
        working-directory: infra
        env:
          TF_LOG: INFO
          TF_LOG_PATH: terraform-debug.log
          TF_VAR_env: ${{ needs.determine-environment.outputs.environment }}
          TF_VAR_subdomain: ${{ needs.determine-environment.outputs.subdomain }}

      - name: Output ACM Records
        if: success()
        run: |
          echo "üëâ DNS Records needed for ACM:"
          terraform output -json acm_dns_validation_records | jq -r '.[] | "Name: \(.name)\nType: \(.type)\nValue: \(.value)\n---"'
        working-directory: infra

      # --------------------------
      # Build Frontend
      # --------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      - name: Build Frontend
        run: npm run build

      - name: Upload to S3
        run: |
          BUCKET=$(terraform -chdir=infra output -raw s3_bucket)
          if [ -d "dist" ]; then BUILD_DIR="dist";
          elif [ -d "build" ]; then BUILD_DIR="build";
          elif [ -d "out" ]; then BUILD_DIR="out";
          else echo "‚ùå No build dir found"; exit 1; fi

          aws s3 sync $BUILD_DIR/ s3://$BUCKET/ --delete --exact-timestamps

      - name: Invalidate CloudFront
        run: |
          DIST=$(terraform -chdir=infra output -raw cloudfront_distribution_id || true)
          if [ -n "$DIST" ]; then
            aws cloudfront create-invalidation --distribution-id "$DIST" --paths "/*"
          else
            echo "‚ö†Ô∏è No CloudFront distribution found"
          fi

      - name: Rollback on Failure
        if: failure() && inputs.rollback_enabled == true && steps.init.outcome == 'success'
        run: terraform destroy -auto-approve
        working-directory: infra
        env:
          TF_VAR_env: ${{ needs.determine-environment.outputs.environment }}
          TF_VAR_subdomain: ${{ needs.determine-environment.outputs.subdomain }}

  # ============================
  # üî• DEBUG JOB (ALWAYS RUNS)
  # ============================
  debug-info:
    if: always()
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: AWS Auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      # Terraform Debug
      - name: Terraform Show
        run: terraform show -json || true
        working-directory: infra

      - name: Terraform State List
        run: terraform state list || true
        working-directory: infra

      - name: Print Terraform Files
        run: find infra -type f -print -exec cat {} \;

      # AWS Debug
      - name: CloudFront Distributions
        run: aws cloudfront list-distributions || true

      - name: Describe Each CloudFront
        run: |
          IDS=$(aws cloudfront list-distributions --query "DistributionList.Items[].Id" --output text)
          for ID in $IDS; do
            echo "--------------------"
            aws cloudfront get-distribution --id $ID || true
          done

      - name: ACM Certificates (us-east-1)
        run: aws acm list-certificates --region us-east-1 || true

      - name: ACM Describe Details
        run: |
          CERTS=$(aws acm list-certificates --region us-east-1 --query "CertificateSummaryList[].CertificateArn" --output text)
          for C in $CERTS; do
            echo "----------------------"
            aws acm describe-certificate --certificate-arn $C --region us-east-1 || true
          done

      - name: Route53 Hosted Zones
        run: aws route53 list-hosted-zones || true

      - name: Route53 Records
        run: |
          ZONES=$(aws route53 list-hosted-zones --query "HostedZones[].Id" --output text)
          for Z in $ZONES; do
            aws route53 list-resource-record-sets --hosted-zone-id $Z || true
          done

      - name: S3 Buckets
        run: aws s3 ls || true

      - name: S3 Bucket Details
        run: |
          for B in $(aws s3 ls --output text | awk '{print $3}'); do
            echo "Bucket: $B"
            aws s3api get-bucket-policy --bucket $B || true
            aws s3api get-bucket-location --bucket $B || true
          done

      - name: Upload Terraform Debug Logs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-debug-log
          path: infra/terraform-debug.log
        continue-on-error: true